<style>
/*http://stackoverflow.com/questions/3148415/how-to-make-a-vertical-line*/
/*.verticalLine { border-left: 2px solid #000000; }*/
/*
table { width:100%; }
#datatable caption { text-align:left; }
#datatable thead th { text-align:center; border-bottom-width:1px; border-top-width:1px; }
#datatable th, td { text-align:center; padding:1px;} 
.tdname { width:100px; }
.tdnameeng { width:100px; }
.tdamount { width:200px; }
.tdchoose { width:50px; }

table.grid {width:100%}
#datatable { width:100%; }

*/
#typechooser { width:100%; text-align:center; /*vertical-align:middle;float:left; padding-right: 2px; margin: 3px; */ }
/*
#selected { display: none; text-align:center;}
#manualinput { display: none; text-align:center;}
#selections { display: none; text-align:center;}
*/
</style>
<script>
$(function() { 
/*
$('#selcollapsible').bind('expand', function () {
    alert('Expanded');
}).bind('collapse', function () {
    alert('Collapsed');
});
$('#selcollapsible').bind('expand', function () {
    alert('Expanded');
});
*/

});

$('#sites').change(siteReload);
$('#maintype').change(maintypeReload);
$('#subtype').change(subtypeReload);

function siteReload()
{
    var mainid = $("#maintype").val();
    var subid = $("#subtype").val();        
    var siteid = $("#sites").val();
    
    var url = "/material/apply/applymaterials?" + "siteid=" + siteid + "&mainid=" + mainid + "&subid=" + subid;
    //alert(url);
    url += "&open=1"; 
    redirect(url);
}


function maintypeReload()
{
    //alert("reload!");
    var mainid = $("#maintype").val();
    var subid = $("#subtype").val();        
    var siteid = $("#sites").val();

    var url = "/material/apply/applymaterials?" + "siteid=" + siteid + "&mainid=" + mainid;
    url += "&open=2"; 
    redirect(url);
}

function subtypeReload()
{
    //alert("reload!");
    var mainid = $("#maintype").val();
    var subid = $("#subtype").val();        
    var siteid = $("#sites").val();

    var url = "/material/apply/applymaterials?" + "siteid=" + siteid + "&subid=" + subid;
    url += "&open=2"; 
    redirect(url);
}

function redirect(url) 
{
	window.location = url;
}

function checkall()
{
    //alert("checkall");
    var checked = false;
    var form = document.dataform;
    
    for (var i = 0; i < form.elements.length; i++) {
        if(form.elements[i].id == 'toggleall')
        {
            checked = form.elements[i].checked;
            break;    
        }    
    }

    for (var i = 0; i < form.elements.length; i++) {    
        if(form.elements[i].type == 'checkbox'){
                form.elements[i].checked = checked;
            }    
    }
}

function submitmaterials()
{
    var r=confirm("Confirm to delete?");
    if (r==false) { return false; }          

    var formname = "dataform";

    var action = "/material/apply/submit";     
    var method = "post";

    var frm = $('#dataform');    
    var toServer = {};
    $('#datatable tbody tr td input').each(function(key, value) {
        toServer[$(this).val()] = $(this).is(':checked');
    });
    
    frm.submit(function () {
        $.ajax({
            type: method,
            url: action,
            data: toServer,
            success: function (data) {
                //alert(data);
                window.location.reload();
            }
        });

        return false;
    });
    
    frm.submit();
}

function addchoosen(id)
{
    //alert("id="+id);
    var amount = $('#slider'+id).val();
    if(amount==0)
    {
        alert("请选择数量");
        return;
    }

    //var remark = $('#remark'+id).val();
    var sitepart = $('#sitepart'+id).val();
    //alert("id="+id+",amount="+amount+",remark="+remark);
    $.post("/material/apply/postdata", { id:id, amount:amount, sitepart:sitepart }, 
        function(data) {
            alert("提交成功，请继续申请材料");
            console.log(data);
            //location.reload();
    });
                
}

//http://stackoverflow.com/questions/178325/testing-if-something-is-hidden-with-jquery
// http://stackoverflow.com/questions/4009524/change-button-text-jquery-mobile
function showselected()
{    
    //alert("showselected");
    //if($("#selected").is(":visible")) {
    //if ($("#selected").css("visibility") == "hidden") {
    if ($("#selected").css('display') == 'none') {    
        $("#selected").show();
        $("#btnSelectedText").html('隐藏已选材料'); 
    }
    else
    {
        $("#selected").hide();    
        $("#btnSelectedText").html('显示已选材料'); 
    }            
}

function submitmanualinput()
{
    var id = 0;    
    var name = $('#manuname').val();
    var amount = $('#manuamount').val();
    var remark = $('#manuremark').val();

    if(name=="" || amount=="" || remark=="")
    {
        alert("请填写完整，再提交");
    }

    $.post("/material/apply/postdata", { id:id, amount:amount, remark:remark, longname:name }, 
        function(data) {
            alert("提交成功，请继续申请材料");
            //console.log(data);
            //location.reload();
    });    
}

function setSiteId()
{
    var siteid = $('#sites').val();
    $("#siteid").val(siteid);
}


function submitselections()
{
    var siteid = $('#siteid').val();
    //alert("submitselections, siteid="+siteid);

    if(siteid == 0)
    {
        alert("请选择申请工地");
        return;    
    }    

    $.post("/material/apply/submitselections", { siteid:siteid },
        function(data) {
            alert(data);
            console.log(data);
            //location.reload();
            //redirect("/material/apply/");    
    });    
}

$('#selcollapsible').bind('expand', function () {
    //alert('Expanded');
    $.post("/material/apply/getselections", 
        function(data) {
            //alert(data);
            //console.log(data);
            $("#seltable").html(data);
    }); 
});

</script>
<?php
$role=$this->role;
$displaynone="";
if($role=="leader")
{
    $displaynone = 'style="display:none"';
}

$sites = $this->sites;
$siteparts = $this->siteparts;
$siteid = $this->siteid;
$sitename = $this->sitename;

$maintypes = $this->maintypes;
$subtypes = $this->subtypes;
$mainid=$this->mainid;
$subid=$this->subid;

// open: which is opened
$open=$this->open;
?>

<input type="hidden" id="siteid" value="0">

<div data-role="collapsible-set" >

<div data-role="collapsible" data-collapsed="<?php if($open==1) echo "false"; else {echo "true";} ?>">
<h3>第一步：选择申请工地 - <?php echo $sitename; ?></h3>
<select id="sites" data-mini="true" data-theme="a">
<option value="0">请选择申请工地</option>
<?php
$options = '';
foreach($sites as $tmp)
{
    $id = $tmp->getId();
    $name = $tmp->getName();

    if($siteid == $id)
    {
        echo '<option value="' . $id . '" selected>' . $name . "</option>";
    }
    else
    {
        echo '<option value="' . $id . '" >' . $name . "</option>";
    }
}
echo $options;
?>
</select>
</div>

<!--按分类选择材料-->
<div data-role="collapsible" data-collapsed="<?php if($open==2) echo "false"; else {echo "true";} ?>">
<h3>第二步：分类选择材料</h3>
<div id="typechooser">
<table class="grid">
<tr>
<td>选择主要类型:</td>
<td>
<select name="maintype" id="maintype" data-mini="true" data-theme="a">
<?php
foreach($maintypes as $tmp)
{
    $id = $tmp->getId();
    $namechs = $tmp->getTypechs();
    $nameeng = $tmp->getTypeeng();

    if($id == $mainid)
    {
        echo "<option value='$id' selected>$namechs</option>";
    }
    else
    {
        echo "<option value='$id'>$namechs</option>";
    }
}
?>   
</select>

</td>
<td>选择子类型:</td>
<td>
<select name="subtype" id="subtype" data-mini="true" data-theme="a">
<?php
foreach($subtypes as $tmp)
{
    $id = $tmp->getId();
    $namechs = $tmp->getTypechs();
    $nameeng = $tmp->getTypeeng();

    if($id == $subid)
    {
        echo "<option value='$id' selected>$namechs</option>";
    }
    else
    {
        echo "<option value='$id'>$namechs</option>";
    }
}
?>   
</select>
</td>
</tr>

</table>

<table id="datatable" class="grid">
<thead><tr>
<th>材料名称</th><th>数量</th><th>单位</th><th>规格</th><th>工程部位</th><th>提交</th>
</tr></thead>
<tbody> 
<?php
/*
$dropdown = '<select data-mini="true"><option value="无定义">无定义</options>';
$options ="";
foreach($siteparts as $tmp)
{
    if($tmp != "")
    {        
        $options .= '<option value="' . $tmp . '">' . $tmp . '</option>';
    }
}
$dropdown .= $options;
$dropdown .= "</select>";
*/
$options='<option value="无定义">无定义</options>';
foreach($siteparts as $tmp)
{
    if($tmp != "")
    {        
        $options .= '<option value="' . $tmp . '">' . $tmp . '</option>';
    }
}

foreach($this->materials as $tmp)
{
    $id = $tmp->getId();
    $name = $tmp->getName();
    $nameeng = $tmp->getNameeng();

    $body = "";
    $longname = '<tr><td class="tdname">' . $name . '/' . $nameeng . '</td>';
    $amount = '<td class="tdamount"><input type="number" name="slider" id="slider' . $id . '" value="" placeholder="0"></td>';
    $unit = "<td></td>";
    $spec = "<td></td>";    
    
    $dropdown = '<select id="sitepart' . $id . '" data-mini="true">';
    $dropdown .= $options;
    $dropdown .= '</select>';
    $td_dropdown = '<td>' . $dropdown . '</td>';    

    $body .= $longname . $amount . $unit . $spec . $td_dropdown;
    $gorightbutton = '<td class="tdchoose"><button onclick="addchoosen(' . $id . ')" data-icon="arrow-r" data-iconpos="bottom" data-inline="true" data-mini="true">提交</button></td>';

    $body .= $gorightbutton;
    $body .= "</tr>";    
    echo $body;
}
?>
</tbody> 
</table>
</div> <!-- typechooser -->
</div>

<!--手动输入材料信息-->
<div data-role="collapsible" data-collapsed="<?php if($open==3) echo "false"; else {echo "true";} ?>"  <?php echo $displaynone; ?> >
<h3>第三步：手动输入材料</h3>
<div id="manualinput">
    <form id="manuform">
    <div data-role="fieldcontain">
    <label for="manuname">输入名称:</label>
    <input type="text" name="manuname" id="manuname" placeholder="材料名称，比如钉子，水泥等" value=""  />
    </div>
    <div data-role="fieldcontain">
    <label for="manuamount">输入数量:</label>
    <input type="text" name="manuamount" id="manuamount" placeholder="填写数量，比如要30包水泥，这里写30" value=""  />
    </div>
    <div data-role="fieldcontain">
    <label for="manuremark">输入规格:</label>
    <textarea cols="40" rows="8" name="manuremark" id="manuremark" placeholder="填写规格说明，比如多大号的钉子，什么水泥等"></textarea>
    </div>
    </form> <!-- manuform -->					    
    <input type="submit" value="提交到选择列表" onclick="submitmanualinput()" data-theme="a">
</div>
</div>

<div id="selcollapsible" data-role="collapsible" data-collapsed="<?php if($open==4) echo "false"; else {echo "true";} ?>">
<h3>最后步：提交已选材料</h3>
<div id="selections">
    <div id="seltable">
    </div>
<input type="submit" value="提交至材料审核人员" onclick="submitselections()" data-theme="a">
</div>

</div>
</div> <!-- collapsible-set -->
<br><br>
